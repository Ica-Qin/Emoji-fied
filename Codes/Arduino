// ========== æ‰“å°æœºåˆ†é… ==========
// P1 â†’ happy / surprise
// P2 â†’ sad
// P3 â†’ angry / fear

HardwareSerial& P1 = Serial1;
HardwareSerial& P2 = Serial2;
HardwareSerial& P3 = Serial3;

// ========== é£æ‰‡ ==========
const int FAN_PIN = 9;
unsigned long fanOffTime = 0;

// ========== å…¶å®ƒ ==========
const unsigned long START_INTERVAL_MS = 30000;
unsigned long lastStart = 0;

void setup() {
  Serial.begin(9600);      // è·Ÿ OpenMV é€šè®¯
  P1.begin(9600);
  P2.begin(9600);
  P3.begin(9600);

  pinMode(FAN_PIN, OUTPUT);
  digitalWrite(FAN_PIN, LOW);

  while (!Serial);
  Serial.println("Arduino READY (Real Print Version). Periodically sending S...");
}

String lineFromOV;
int imgW = 0, imgH = 0;
bool receivingImage = false;

// === è¡¨æƒ…ç¼“å­˜ ===
String lastLabel = "";
String lastScore = "";
int currentPrinter = 1;   // 1/2/3 å¯¹åº”ä¸‰å°æ‰“å°æœº

void loop() {

  // ========== 1. å®šæ—¶å‘é€ 'S' æŒ‡ä»¤ç»™ OpenMV ==========
  unsigned long now = millis();
  if (now - lastStart >= START_INTERVAL_MS) {
    lastStart = now;
    Serial.write('S');
    Serial.println("[Arduino] Sent 'S'");
  }

  // ========== 2. æ¥æ”¶ OpenMV ä¸²å£æ•°æ® ==========
  while (Serial.available()) {
    char c = Serial.read();
    if (c == '\n') {
      processLine(lineFromOV);
      lineFromOV = "";
    } else if (c != '\r') {
      lineFromOV += c;
    }
  }

  // ========== 3. é£æ‰‡å®šæ—¶å…³é—­ ==========
  if (fanOffTime > 0 && millis() >= fanOffTime) {
    digitalWrite(FAN_PIN, LOW);
    fanOffTime = 0;
    Serial.println("[Arduino] FAN OFF");
  }
}


// ========== è§£æè¡Œ ==========
void processLine(String line) {

  // =====================================================
  //                      EMO,label,score
  // =====================================================
  if (line.startsWith("EMO")) {

    int p1 = line.indexOf(',');
    int p2 = line.indexOf(',', p1 + 1);

    if (p1 > 0 && p2 > p1) {
      lastLabel = line.substring(p1 + 1, p2);
      lastScore = line.substring(p2 + 1);
    }

    Serial.print("[Arduino] Expression = ");
    Serial.print(lastLabel);
    Serial.print(" | Score = ");
    Serial.println(lastScore);

    // ğŸ”µ æ”¶åˆ°è¡¨æƒ… â†’ é£æ‰‡å¼€ 30 ç§’
    digitalWrite(FAN_PIN, HIGH);
    fanOffTime = millis() + 30000;
    Serial.println("[Arduino] FAN ON for 30s");

    // =====================================================
    //     æ ¹æ®è¡¨æƒ…é€‰æ‹©æ‰“å°æœºï¼ˆæŒ‰ä½ ç°åœ¨ç»™çš„è§„åˆ™ï¼‰
    // =====================================================
    String L = lastLabel;

    if (L == "happy" || L == "surprise") {
      currentPrinter = 1;      // P1
    }
    else if (L == "sad") {
      currentPrinter = 2;      // P2
    }
    else if (L == "angry" || L == "fear") {
      currentPrinter = 3;      // P3
    } else {
      // å…œåº•ï¼šå¦‚æœå‡ºç°å…¶å®ƒ labelï¼Œå°±ç”¨ 1 å·æœº
      currentPrinter = 1;
    }

    Serial.print("[Arduino] Use Printer ");
    Serial.println(currentPrinter);

    return;
  }

  // =====================================================
  //                   IMG,w,h
  // =====================================================
  if (line.startsWith("IMG")) {
    int p1 = line.indexOf(',');
    int p2 = line.indexOf(',', p1 + 1);

    imgW = line.substring(p1 + 1, p2).toInt();
    imgH = line.substring(p2 + 1).toInt();

    receivingImage = true;

    Serial.print("[Arduino] Receiving image ");
    Serial.print(imgW);
    Serial.print(" x ");
    Serial.println(imgH);

    HardwareSerial *P = getPrinter();

    // ------- æ‰“å°è¡¨æƒ…æ–‡å­— -------
    (*P).println("");
    (*P).println("Expression: " + lastLabel);
    (*P).println("Score: " + lastScore);
    (*P).println("----------------------");
    (*P).println("");

    return;
  }

  // =====================================================
  //                 æ¥æ”¶å›¾åƒä½å›¾è¡Œ
  // =====================================================
  if (receivingImage) {

    if (line.length() != imgW) {
      Serial.println("[Arduino] Bad row length, ignored.");
      return;
    }

    HardwareSerial *P = getPrinter();

    // ESC/POS raster bit image
    (*P).write(0x1D); (*P).write(0x76); (*P).write(0x30); (*P).write(0x00);
    (*P).write((imgW + 7) / 8);
    (*P).write(0x00);
    (*P).write(0x01);
    (*P).write(0x00);

    for (int i = 0; i < imgW; i += 8) {
      uint8_t b = 0;
      for (int bit = 0; bit < 8; bit++) {
        if (i + bit < imgW && line[i + bit] == '1') {
          b |= (0x80 >> bit);
        }
      }
      (*P).write(b);
    }

    static int receivedRows = 0;
    receivedRows++;

    if (receivedRows >= imgH) {
      Serial.println("[Arduino] Image done");

      (*P).println("");
      (*P).println("------ END ------");
      (*P).println("");

      receivedRows = 0;
      receivingImage = false;
    }

    return;
  }
}


// ========== æ ¹æ® currentPrinter è¿”å›æŒ‡é’ˆ ==========
HardwareSerial* getPrinter() {
  if (currentPrinter == 1) return &P1;
  if (currentPrinter == 2) return &P2;
  return &P3;  // 3
}
